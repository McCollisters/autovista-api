container_commands:
  01_install:
    command: |
      echo "=== Installing dependencies ==="
      echo "Current directory: $(pwd)"
      echo "Node version: $(node --version)"
      echo "NPM version: $(npm --version || echo 'npm not found')"
      
      echo "Checking if package.json exists:"
      if [ ! -f "package.json" ]; then
        echo "ERROR: package.json not found!"
        exit 1
      fi
      
      echo "Checking if dist/index.js already exists:"
      if [ -f "dist/index.js" ]; then
        echo "dist/index.js exists - installing minimal dependencies for runtime"
        echo "Installing production dependencies only..."
        npm install --production --no-audit --no-fund || {
          echo "Production install failed, trying full install..."
          npm install --no-audit --no-fund || echo "Warning: npm install had issues but continuing since dist/index.js exists..."
        }
      else
        echo "dist/index.js not found - installing all dependencies for build"
        echo "Running npm ci..."
        npm ci --no-audit --no-fund || {
          echo "npm ci failed, trying npm install..."
          npm install --no-audit --no-fund || {
            echo "ERROR: Failed to install dependencies and dist/index.js doesn't exist!"
            exit 1
          }
        }
      fi
      
      echo "=== Dependencies installed ==="
    leader_only: true
  02_build:
    command: |
      echo "=== Checking if build is needed ==="
      echo "Current directory: $(pwd)"
      if [ -f "dist/index.js" ]; then
        echo "dist/index.js already exists - skipping build"
        echo "Using pre-built dist folder from deployment package"
        ls -la dist/index.js
      else
        echo "dist/index.js not found - building application..."
        echo "Node version: $(node --version)"
        echo "Checking if src/index.ts exists:"
        if [ ! -f "src/index.ts" ]; then
          echo "ERROR: src/index.ts not found!"
          exit 1
        fi
        
        echo "Verifying TypeScript is available:"
        npx tsc --version || (echo "TypeScript not found, installing..." && npm install --save-dev typescript)
        
        echo "Running build command..."
        npm run build || (echo "Build failed, but checking if dist was created anyway..." && true)
        
        echo "=== Build step completed ==="
        echo "Checking build output:"
        if [ ! -d "dist" ]; then
          echo "ERROR: dist directory not found after build!"
          exit 1
        fi
        if [ ! -f "dist/index.js" ]; then
          echo "ERROR: dist/index.js not found after build!"
          echo "Contents of dist directory:"
          ls -la dist/ || echo "dist directory is empty or doesn't exist"
          exit 1
        fi
        echo "Build successful - dist/index.js exists"
        ls -la dist/index.js
      fi
    leader_only: true
  03_postbuild:
    command: |
      echo "=== Running postbuild script ==="
      node fix-imports.cjs || echo "Postbuild script failed but continuing..."
      echo "=== Postbuild completed ==="
    leader_only: true
  03_copy_templates:
    command: |
      echo "=== Copying templates to dist ==="
      if [ -d "src/templates" ]; then
        mkdir -p dist/templates
        cp -r src/templates/* dist/templates/ || echo "Warning: Failed to copy some templates"
        echo "Templates copied to dist/templates"
        ls -la dist/templates/ | head -5
      else
        echo "Warning: src/templates directory not found"
      fi
    leader_only: true
  04_verify_build:
    command: |
      echo "=== Verifying build output ==="
      echo "Current directory: $(pwd)"
      echo "Checking if dist directory exists:"
      if [ ! -d "dist" ]; then
        echo "ERROR: dist directory not found!"
        echo "Listing current directory:"
        ls -la
        exit 1
      fi
      echo "Checking if index.js exists:"
      if [ ! -f "dist/index.js" ]; then
        echo "ERROR: dist/index.js not found!"
        echo "Contents of dist directory:"
        ls -la dist/ || echo "dist directory is empty"
        exit 1
      fi
      echo "Build verification passed - dist/index.js exists"
      ls -la dist/index.js
    leader_only: true

option_settings:
  aws:elasticbeanstalk:application:environment:
    NODE_ENV: "production"
  aws:elasticbeanstalk:healthreporting:system:
    SystemType: enhanced
    HealthCheckSuccessThreshold: Ok
