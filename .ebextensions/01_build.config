container_commands:
  01_install:
    command: |
      echo "=== Installing dependencies ==="
      npm ci || (echo "npm ci failed, trying npm install" && npm install)
      echo "=== Dependencies installed ==="
    leader_only: true
  02_build:
    command: |
      echo "=== Building application ==="
      echo "Current directory: $(pwd)"
      echo "Node version: $(node --version)"
      echo "Checking if src/index.ts exists:"
      ls -la src/index.ts || echo "WARNING: src/index.ts not found"
      echo "Running build command..."
      npm run build || echo "Build reported errors, but continuing to check output..."
      echo "=== Build step completed ==="
      echo "Checking build output:"
      ls -la dist/ 2>/dev/null || echo "WARNING: dist directory not found after build"
    leader_only: true
  03_postbuild:
    command: |
      echo "=== Running postbuild script ==="
      node fix-imports.cjs || echo "Postbuild script failed but continuing..."
      echo "=== Postbuild completed ==="
    leader_only: true
  04_verify_build:
    command: |
      echo "=== Verifying build output ==="
      echo "Checking if dist directory exists:"
      ls -la dist/ || (echo "ERROR: dist directory not found!" && exit 1)
      echo "Checking if index.js exists:"
      ls -la dist/index.js || (echo "ERROR: dist/index.js not found!" && exit 1)
      echo "Build verification passed - dist/index.js exists"
    leader_only: true

option_settings:
  aws:elasticbeanstalk:application:environment:
    NODE_ENV: "production"
  aws:elasticbeanstalk:healthreporting:system:
    SystemType: enhanced
    HealthCheckSuccessThreshold: Ok
