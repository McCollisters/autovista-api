container_commands:
  01_install:
    command: |
      echo "=== Installing dependencies ==="
      echo "Current directory: $(pwd)"
      npm ci || (echo "npm ci failed, trying npm install" && npm install)
      echo "=== Dependencies installed ==="
      echo "Verifying TypeScript is installed:"
      npx tsc --version || (echo "ERROR: TypeScript not found!" && exit 1)
    leader_only: true
  02_build:
    command: |
      echo "=== Checking if build is needed ==="
      echo "Current directory: $(pwd)"
      if [ -f "dist/index.js" ]; then
        echo "dist/index.js already exists - skipping build"
        echo "Using pre-built dist folder from deployment package"
        ls -la dist/index.js
      else
        echo "dist/index.js not found - building application..."
        echo "Node version: $(node --version)"
        echo "Checking if src/index.ts exists:"
        ls -la src/index.ts || (echo "ERROR: src/index.ts not found!" && exit 1)
        echo "Running build command..."
        npm run build
        echo "=== Build step completed ==="
        echo "Checking build output:"
        if [ ! -d "dist" ]; then
          echo "ERROR: dist directory not found after build!"
          exit 1
        fi
        if [ ! -f "dist/index.js" ]; then
          echo "ERROR: dist/index.js not found after build!"
          echo "Contents of dist directory:"
          ls -la dist/ || echo "dist directory is empty or doesn't exist"
          exit 1
        fi
        echo "Build successful - dist/index.js exists"
        ls -la dist/index.js
      fi
    leader_only: true
  03_postbuild:
    command: |
      echo "=== Running postbuild script ==="
      node fix-imports.cjs || echo "Postbuild script failed but continuing..."
      echo "=== Postbuild completed ==="
    leader_only: true
  04_verify_build:
    command: |
      echo "=== Verifying build output ==="
      echo "Current directory: $(pwd)"
      echo "Checking if dist directory exists:"
      if [ ! -d "dist" ]; then
        echo "ERROR: dist directory not found!"
        echo "Listing current directory:"
        ls -la
        exit 1
      fi
      echo "Checking if index.js exists:"
      if [ ! -f "dist/index.js" ]; then
        echo "ERROR: dist/index.js not found!"
        echo "Contents of dist directory:"
        ls -la dist/ || echo "dist directory is empty"
        exit 1
      fi
      echo "Build verification passed - dist/index.js exists"
      ls -la dist/index.js
    leader_only: true

option_settings:
  aws:elasticbeanstalk:application:environment:
    NODE_ENV: "production"
  aws:elasticbeanstalk:healthreporting:system:
    SystemType: enhanced
    HealthCheckSuccessThreshold: Ok
