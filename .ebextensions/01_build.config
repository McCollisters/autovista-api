container_commands:
  01_verify_node:
    command: |
      set -e
      echo "=== Verifying Node.js version ==="
      echo "Node version: $(node --version)"
      echo "NPM version: $(npm --version)"
      echo "Expected Node.js 22.x"
      NODE_VERSION=$(node --version)
      if [[ ! "$NODE_VERSION" =~ ^v22\. ]]; then
        echo "ERROR: Node.js version is $NODE_VERSION, expected v22.x"
        echo "Please ensure the platform is set to Node.js 22"
        exit 1
      fi
      echo "=== Node.js version verified ==="
    leader_only: true
  02_install:
    command: |
      set -e
      echo "=== Installing dependencies ==="
      echo "Node version: $(node --version)"
      echo "NPM version: $(npm --version)"
      echo "Current directory: $(pwd)"
      echo "Contents:"
      ls -la
      if ! npm ci; then
        echo "npm ci failed, trying npm install"
        npm install
      fi
      echo "=== Dependencies installed ==="
    leader_only: true
  03_build:
    command: |
      set -e
      echo "=== Building application ==="
      echo "Current directory: $(pwd)"
      echo "Node version: $(node --version)"
      echo "Checking if node_modules exists:"
      ls -la node_modules/ | head -5 || echo "node_modules not found!"
      echo "Running build..."
      npm run build
      echo "=== Build completed ==="
    leader_only: true
  04_postbuild:
    command: |
      set -e
      echo "=== Running postbuild script ==="
      if [ -f "fix-imports.cjs" ]; then
        node fix-imports.cjs
        echo "Postbuild script completed"
      else
        echo "fix-imports.cjs not found, skipping postbuild"
      fi
      echo "=== Postbuild completed ==="
    leader_only: true
  05_verify_build:
    command: |
      set -e
      echo "=== Build Verification ==="
      echo "Checking if dist directory exists:"
      if [ ! -d "dist" ]; then
        echo "ERROR: dist directory not found!"
        exit 1
      fi
      ls -la dist/ | head -10
      echo "Checking if index.js exists:"
      if [ ! -f "dist/index.js" ]; then
        echo "ERROR: dist/index.js not found!"
        exit 1
      fi
      ls -la dist/index.js
      echo "=== Build verification passed ==="
    leader_only: true

option_settings:
  aws:elasticbeanstalk:application:environment:
    NODE_ENV: "production"

