name: Deploy to Elastic Beanstalk

on:
  push:
    branches: [main]
  workflow_dispatch: # Allow manual triggers

jobs:
  deploy:
    runs-on: ubuntu-latest
    environment: production

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "22"
          cache: "npm"

      - name: Install dependencies
        run: npm ci

      - name: Create deployment package
        run: |
          zip -r autovista-api.zip . \
            -x "node_modules/*" \
            -x ".git/*" \
            -x "*.log" \
            -x ".DS_Store" \
            -x ".github/*" \
            -x "tests/*" \
            -x "*.test.ts" \
            -x "*.test.js" \
            -x "*.spec.ts" \
            -x "*.spec.js" \
            -x "coverage/*" \
            -x ".vscode/*" \
            -x ".idea/*" \
            -x "*.md" \
            -x "logs/*"

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: us-east-1

      - name: Check IAM permissions
        run: |
          echo "Checking current IAM user permissions..."
          aws sts get-caller-identity

          echo "Checking if SNS permissions are available..."
          aws sns list-topics --region us-east-1 || echo "SNS permissions not available"

          echo "Checking Elastic Beanstalk permissions..."
          aws elasticbeanstalk describe-applications --region us-east-1 || echo "EB permissions not available"

      - name: Check environment status and version
        run: |
          echo "Checking environment status..."
          ENV_INFO=$(aws elasticbeanstalk describe-environments \
            --environment-names autovista-api-new-env \
            --query 'Environments[0].{Status:Status,Health:Health,VersionLabel:VersionLabel}' \
            --output json)

          echo "Environment info: $ENV_INFO"

          STATUS=$(echo $ENV_INFO | jq -r '.Status')
          HEALTH=$(echo $ENV_INFO | jq -r '.Health')
          VERSION=$(echo $ENV_INFO | jq -r '.VersionLabel')

          echo "Current environment status: $STATUS"
          echo "Current environment health: $HEALTH"
          echo "Current version: $VERSION"

          # If environment has Sample version and is degraded, we'll deploy to fix it
          if [ "$VERSION" = "Sample" ] && [ "$HEALTH" = "Degraded" ]; then
            echo "Environment has Sample version and is degraded. Deployment will replace it."
          elif [ "$STATUS" = "Updating" ] || [ "$STATUS" = "Launching" ]; then
            echo "Environment is currently updating. Waiting for it to complete..."
          elif [ "$HEALTH" = "Red" ] || [ "$HEALTH" = "Degraded" ]; then
            echo "Warning: Environment health is $HEALTH. Proceeding with deployment to recover..."
          fi

      - name: Wait for environment to be ready
        run: |
          echo "Waiting for environment to be ready..."
          TIMEOUT=600  # 10 minutes timeout
          ELAPSED=0

          while [ $ELAPSED -lt $TIMEOUT ]; do
            STATUS=$(aws elasticbeanstalk describe-environments \
              --environment-names autovista-api-new-env \
              --query 'Environments[0].Status' \
              --output text)
            
            HEALTH=$(aws elasticbeanstalk describe-environments \
              --environment-names autovista-api-new-env \
              --query 'Environments[0].Health' \
              --output text)
            
            echo "Current environment status: $STATUS, health: $HEALTH (elapsed: ${ELAPSED}s)"
            
            if [ "$STATUS" = "Ready" ]; then
              echo "Environment is ready for deployment"
              break
            elif [ "$STATUS" = "Failed" ]; then
              echo "Environment is in failed state. Attempting to recover..."
              # Try to recover by initiating a new deployment with the current version
              CURRENT_VERSION=$(aws elasticbeanstalk describe-environments \
                --environment-names autovista-api-new-env \
                --query 'Environments[0].VersionLabel' \
                --output text)
              echo "Current version: $CURRENT_VERSION"
              echo "You may need to manually recover the environment in AWS Console"
              exit 1
            elif [ "$STATUS" = "Terminated" ]; then
              echo "Environment has been terminated. Please recreate it."
              exit 1
            else
              echo "Environment is not ready yet. Waiting 30 seconds..."
              sleep 30
              ELAPSED=$((ELAPSED + 30))
            fi
          done

          if [ $ELAPSED -ge $TIMEOUT ]; then
            echo "Timeout waiting for environment to be ready"
            exit 1
          fi

      - name: Deploy to Elastic Beanstalk
        uses: einaregilsson/beanstalk-deploy@v21
        with:
          aws_access_key: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws_secret_key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          application_name: autovista-api
          environment_name: autovista-api-new-env
          region: us-east-1
          version_label: "autovista-api-v${{ github.run_number }}-${{ github.sha }}"
          deployment_package: autovista-api.zip
          wait_for_deployment: true
          use_existing_version_if_available: true
          wait_for_environment_recovery: 0
        continue-on-error: true

      - name: Fetch application logs
        run: |
          echo "=== Fetching application logs ==="
          aws elasticbeanstalk retrieve-environment-info \
            --environment-name autovista-api-new-env \
            --info-type tail

          echo "=== Recent application events ==="
          aws elasticbeanstalk describe-events \
            --environment-name autovista-api-new-env \
            --max-items 5

      - name: Configure AWS credentials for failure logs
        if: failure()
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: us-east-1

      - name: Fetch logs on deployment failure
        if: failure()
        run: |
          echo "=== Deployment failed, fetching logs ==="

          # Get the latest log files
          aws elasticbeanstalk retrieve-environment-info \
            --environment-name autovista-api-new-env \
            --info-type tail

          echo "=== Recent events ==="
          aws elasticbeanstalk describe-events \
            --environment-name autovista-api-new-env \
            --max-items 20

          echo "=== Environment health and status ==="
          aws elasticbeanstalk describe-environments \
            --environment-names autovista-api-new-env \
            --query 'Environments[0].{Health:Health,HealthStatus:HealthStatus,Status:Status,VersionLabel:VersionLabel}'

          echo "=== Checking for aborted deployments ==="
          EVENTS=$(aws elasticbeanstalk describe-events \
            --environment-name autovista-api-new-env \
            --max-items 5 \
            --query 'Events[?contains(Message, `aborted`) || contains(Message, `Aborted`)].{Time:EventDate,Message:Message}' \
            --output text)

          if [ -n "$EVENTS" ]; then
            echo "Found aborted deployment events:"
            echo "$EVENTS"
            echo ""
            echo "RECOMMENDATION: If you see aborted deployment errors, you may need to:"
            echo "1. Wait for the environment to stabilize"
            echo "2. Manually trigger a new deployment from AWS Console"
            echo "3. Or re-run this workflow after the environment is in 'Ready' status"
          fi

          echo "=== Fetching eb-engine.log ==="
          aws elasticbeanstalk retrieve-environment-info \
            --environment-name autovista-api-new-env \
            --info-type bundle

          # Exit with error to fail the workflow
          exit 1
