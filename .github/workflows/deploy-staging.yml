name: Deploy to Elastic Beanstalk (Staging)

on:
  push:
    branches: [staging]
  workflow_dispatch: # Allow manual triggers

jobs:
  deploy:
    runs-on: ubuntu-latest
    environment: staging
    env:
      VERSION_LABEL: autovista-api-staging-v${{ github.run_number }}-${{ github.sha }}
      EB_BUCKET: elasticbeanstalk-us-east-1-016551391727

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Use staging env file if present
        run: |
          if [ -f ".env.staging" ]; then
            echo "Using .env.staging for staging build/runtime"
            cp .env.staging .env
          else
            echo "No .env.staging found; relying on environment variables"
          fi

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "22"
          cache: "npm"

      - name: Install dependencies
        run: npm ci

      - name: Build application
        run: |
          echo "Building application locally..."
          npm run build
          echo "Verifying build output..."
          if [ ! -f "dist/index.js" ]; then
            echo "ERROR: dist/index.js not found after build!"
            exit 1
          fi
          echo "Build successful - dist/index.js exists"
          ls -la dist/index.js

      - name: Create deployment package
        run: |
          zip -r autovista-api.zip . \
            -x "node_modules/*" \
            -x ".git/*" \
            -x "*.log" \
            -x ".DS_Store" \
            -x ".github/*" \
            -x "tests/*" \
            -x "*.test.ts" \
            -x "*.test.js" \
            -x "*.spec.ts" \
            -x "*.spec.js" \
            -x "coverage/*" \
            -x ".vscode/*" \
            -x ".idea/*" \
            -x "*.md" \
            -x "logs/*"

          echo "=== Verifying deployment package contents ==="
          echo "Checking if routes files are included:"
          unzip -l autovista-api.zip | grep -E "routes\.(ts|js)" || echo "Warning: No routes files found in package!"
          echo "Checking if dist folder exists:"
          unzip -l autovista-api.zip | grep "dist/index.js" || echo "Warning: dist/index.js not found in package!"
          echo "Checking if user routes are included:"
          unzip -l autovista-api.zip | grep "src/user/routes" || echo "Warning: src/user/routes.ts not found!"
          echo "Package size:"
          ls -lh autovista-api.zip

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: us-east-1

      - name: Create Elastic Beanstalk application version
        run: |
          echo "Uploading application version $VERSION_LABEL to $EB_BUCKET"
          aws s3 cp autovista-api.zip "s3://$EB_BUCKET/$VERSION_LABEL.zip"
          aws elasticbeanstalk create-application-version \
            --application-name autovista-api \
            --version-label "$VERSION_LABEL" \
            --source-bundle S3Bucket="$EB_BUCKET",S3Key="$VERSION_LABEL.zip" \
            --region us-east-1

      - name: Check IAM permissions
        run: |
          echo "Checking current IAM user permissions..."
          aws sts get-caller-identity

          echo "Checking if SNS permissions are available..."
          aws sns list-topics --region us-east-1 || echo "SNS permissions not available"

          echo "Checking Elastic Beanstalk permissions..."
          aws elasticbeanstalk describe-applications --region us-east-1 || echo "EB permissions not available"

      - name: Check environment status and version
        run: |
          echo "Checking environment status..."
          ENV_INFO=$(aws elasticbeanstalk describe-environments \
            --environment-names autovista-api-staging \
            --query 'Environments[0].{Status:Status,Health:Health,VersionLabel:VersionLabel}' \
            --output json)

          echo "Environment info: $ENV_INFO"

          STATUS=$(echo $ENV_INFO | jq -r '.Status')
          HEALTH=$(echo $ENV_INFO | jq -r '.Health')
          VERSION=$(echo $ENV_INFO | jq -r '.VersionLabel')

          echo "Current environment status: $STATUS"
          echo "Current environment health: $HEALTH"
          echo "Current version: $VERSION"

          # If environment has Sample version and is degraded, we'll deploy to fix it
          if [ "$VERSION" = "Sample" ] && [ "$HEALTH" = "Degraded" ]; then
            echo "Environment has Sample version and is degraded. Deployment will replace it."
          elif [ "$STATUS" = "Updating" ] || [ "$STATUS" = "Launching" ]; then
            echo "Environment is currently updating. Waiting for it to complete..."
          elif [ "$HEALTH" = "Red" ] || [ "$HEALTH" = "Degraded" ]; then
            echo "Warning: Environment health is $HEALTH. Proceeding with deployment to recover..."
          fi

      - name: Wait for environment to be ready
        run: |
          echo "Waiting for environment to be ready..."
          TIMEOUT=600  # 10 minutes timeout
          ELAPSED=0
          MAX_WAIT_ITERATIONS=20  # Maximum 20 iterations (10 minutes)
          ITERATION=0

          while [ $ELAPSED -lt $TIMEOUT ] && [ $ITERATION -lt $MAX_WAIT_ITERATIONS ]; do
            STATUS=$(aws elasticbeanstalk describe-environments \
              --environment-names autovista-api-staging \
              --query 'Environments[0].Status' \
              --output text)
            
            HEALTH=$(aws elasticbeanstalk describe-environments \
              --environment-names autovista-api-staging \
              --query 'Environments[0].Health' \
              --output text)
            
            echo "Current environment status: $STATUS, health: $HEALTH (elapsed: ${ELAPSED}s, iteration: $ITERATION)"
            
            if [ "$STATUS" = "Ready" ]; then
              echo "Environment is ready for deployment"
              break
            elif [ "$STATUS" = "Updating" ] || [ "$STATUS" = "Launching" ]; then
              ITERATION=$((ITERATION + 1))
              if [ $ITERATION -ge $MAX_WAIT_ITERATIONS ]; then
                echo "ERROR: Environment has been updating for too long. It may be stuck in a loop."
                echo "Please check the AWS Console and stop any ongoing updates before deploying again."
                exit 1
              fi
              echo "Environment is still updating. Waiting 30 seconds... (iteration $ITERATION/$MAX_WAIT_ITERATIONS)"
              sleep 30
              ELAPSED=$((ELAPSED + 30))
            elif [ "$STATUS" = "Failed" ]; then
              echo "Environment is in failed state. Stopping deployment to prevent loop."
              echo "Please fix the environment in AWS Console before deploying again."
              exit 1
            elif [ "$STATUS" = "Terminated" ]; then
              echo "Environment has been terminated. Please recreate it."
              exit 1
            else
              echo "Environment is not ready yet. Waiting 30 seconds..."
              sleep 30
              ELAPSED=$((ELAPSED + 30))
            fi
          done

          if [ $ELAPSED -ge $TIMEOUT ] || [ $ITERATION -ge $MAX_WAIT_ITERATIONS ]; then
            echo "Timeout waiting for environment to be ready"
            echo "Environment may be stuck. Please check AWS Console before retrying."
            exit 1
          fi

      - name: Final check before deployment
        run: |
          echo "Final check: Ensuring environment is ready for deployment..."
          STATUS=$(aws elasticbeanstalk describe-environments \
            --environment-names autovista-api-staging \
            --query 'Environments[0].Status' \
            --output text)

          if [ "$STATUS" != "Ready" ]; then
            echo "ERROR: Environment status is '$STATUS', not 'Ready'"
            echo "Cannot deploy while environment is updating/aborting. Please wait for it to be Ready."
            exit 1
          fi

          echo "Environment is Ready. Proceeding with deployment..."

      - name: Deploy to Elastic Beanstalk
        uses: einaregilsson/beanstalk-deploy@v21
        with:
          aws_access_key: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws_secret_key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          application_name: autovista-api
          environment_name: autovista-api-staging
          region: us-east-1
          version_label: ${{ env.VERSION_LABEL }}
          deployment_package: autovista-api.zip
          wait_for_deployment: true
          use_existing_version_if_available: true
          wait_for_environment_recovery: 0
        continue-on-error: true

      - name: Invalidate CloudFront Cache
        if: success()
        run: |
          echo "Invalidating CloudFront cache after deployment..."

          DISTRIBUTION_ID="${{ secrets.CLOUDFRONT_DISTRIBUTION_ID_STAGING }}"
          if [ -z "$DISTRIBUTION_ID" ]; then
            DISTRIBUTION_ID="E2HZSS7O0OPQSE"
          fi

          if [ -z "$DISTRIBUTION_ID" ]; then
            echo "Warning: CLOUDFRONT_DISTRIBUTION_ID_STAGING secret not set. Skipping cache invalidation."
            exit 0
          fi

          echo "Creating CloudFront invalidation for distribution: $DISTRIBUTION_ID"

          # Invalidate API paths that commonly change
          INVALIDATION_ID=$(aws cloudfront create-invalidation \
            --distribution-id "$DISTRIBUTION_ID" \
            --paths "/api/v1/user" "/api/v1/users" "/api/v1/user/*" "/api/*" \
            --query 'Invalidation.Id' \
            --output text \
            --region us-east-1)

          if [ -n "$INVALIDATION_ID" ]; then
            echo "CloudFront invalidation created: $INVALIDATION_ID"
            echo "Cache invalidation is in progress. This may take a few minutes."
          else
            echo "Warning: Failed to create CloudFront invalidation"
            exit 0  # Don't fail the deployment if cache invalidation fails
          fi

      - name: Fetch application logs
        run: |
          echo "=== Fetching application logs ==="
          aws elasticbeanstalk retrieve-environment-info \
            --environment-name autovista-api-staging \
            --info-type tail

          echo "=== Recent application events ==="
          aws elasticbeanstalk describe-events \
            --environment-name autovista-api-staging \
            --max-items 5

      - name: Configure AWS credentials for failure logs
        if: failure()
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: us-east-1

      - name: Fetch logs on deployment failure
        if: failure()
        run: |
          echo "=== Deployment failed, fetching logs ==="

          # Get the latest log files
          aws elasticbeanstalk retrieve-environment-info \
            --environment-name autovista-api-staging \
            --info-type tail

          echo "=== Recent events ==="
          aws elasticbeanstalk describe-events \
            --environment-name autovista-api-staging \
            --max-items 20

          echo "=== Environment health and status ==="
          aws elasticbeanstalk describe-environments \
            --environment-names autovista-api-staging \
            --query 'Environments[0].{Health:Health,HealthStatus:HealthStatus,Status:Status,VersionLabel:VersionLabel}'

          echo "=== Checking for aborted deployments ==="
          EVENTS=$(aws elasticbeanstalk describe-events \
            --environment-name autovista-api-staging \
            --max-items 5 \
            --query 'Events[?contains(Message, `aborted`) || contains(Message, `Aborted`)].{Time:EventDate,Message:Message}' \
            --output text)

          if [ -n "$EVENTS" ]; then
            echo "Found aborted deployment events:"
            echo "$EVENTS"
            echo ""
            echo "RECOMMENDATION: If you see aborted deployment errors, you may need to:"
            echo "1. Wait for the environment to stabilize"
            echo "2. Manually trigger a new deployment from AWS Console"
            echo "3. Or re-run this workflow after the environment is in 'Ready' status"
          fi

          echo "=== Fetching eb-engine.log ==="
          aws elasticbeanstalk retrieve-environment-info \
            --environment-name autovista-api-staging \
            --info-type bundle

          # Exit with error to fail the workflow
          exit 1
